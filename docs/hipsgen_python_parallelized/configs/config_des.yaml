# =============================================================================
# HiPS Catalog Pipeline — config.yaml
# =============================================================================
# Configuration file for Hipsgen-cat.py
#
# The pipeline:
#   - Reads large catalogs (Parquet / CSV / TSV / HATS)
#   - Distributes data with Dask or LSDB (depending on format)
#   - Selects sources per HEALPix coverage cell (__icov__)
#   - Writes HiPS-compliant tiles (Norder*/Dir*/Npix*.tsv)
#   - Produces MOC, density maps, metadata, and logs
#
# HATS catalogs:
#   - Opened via lsdb.open_catalog()
#   - Preserve LSDB structure and HEALPix partitioning
#   - Use existing HEALPix index (_healpix_<order>) for __icov__ and density maps
#   - Skip repartitioning and shuffle to ensure consistency
# =============================================================================


# -----------------------------------------------------------------------------
# Input catalog(s)
# -----------------------------------------------------------------------------
input:
  # Input file(s) or directories (supports wildcards).
  # Parquet/CSV/TSV → file paths; HATS → root catalog folder.
  paths:
    - "/scratch/users/luigi.silva/curso-hpc/des_dr2_cut_spatial/*.parquet"

  # Format: "parquet", "csv", "tsv", or "hats"
  format: parquet

  # For CSV/TSV:
  #   header: true  → first row has column names
  #   header: false → positional columns (RA/DEC/score as 1-based indices)
  # header: true

  # Optional hint for ASCII formats (usually not needed).
  # ascii_format: CSV


# -----------------------------------------------------------------------------
# Column mapping and score definition
# -----------------------------------------------------------------------------
columns:
  # RA/DEC column names or 1-based indices (if no header).
  ra: RA
  dec: DEC

  # Score expression to rank sources within each coverage cell/tile.
  # Example: "MAG_I" or "(FLUX_R / ERR_R)**2"
  # order_desc=false → lower is better; true → higher is better.
  score: "MAG_AUTO_I_DERED"

  # Optional explicit list of columns to keep in output tiles.
  # If omitted, keeps RA/DEC, score-related, and all input columns.
  keep:
    - MAG_AUTO_G_DERED
    # - MAG_AUTO_R_DERED
    # - ...


# -----------------------------------------------------------------------------
# Algorithmic controls
# -----------------------------------------------------------------------------
algorithm:

  # ==============================
  # Shared core settings (both modes)
  # ==============================
  # Selection strategy:
  #   coverage   → coverage-based selection (k_per_cov, score, etc.)
  #   mag_global → global magnitude-complete selection
  selection_mode: "coverage"

  # Maximum HiPS order (tiles written for all levels ≤ this).
  level_limit: 11

  # HEALPix order used for MOC and global density maps.
  level_coverage: 10

  # HEALPix order used for densmaps and, in coverage mode, for coverage cells (__icov__).
  coverage_order: 10


  # ==============================
  # Coverage-based mode ONLY
  # (selection_mode: coverage)
  # ==============================

  # Use HATS catalog partitioning as coverage cells (format: hats only).
  # When true, coverage_order is ignored.
  use_hats_as_coverage: false

  # Score ordering for coverage-based ranking:
  #   false → ascending (lower score is better)
  #   true  → descending (higher score is better)
  order_desc: false

  # Density variation with depth for k_per_cov or targets_total:
  #   "constant", "linear", "exp", or "log".
  density_mode: "exp"

  # Base expected number of rows per coverage cell at depth=1.
  # Mutually exclusive with targets_total_initial.
  k_per_cov_initial: 0.05

  # Base expected total number of rows at depth=1 (alternative to k_per_cov_initial).
  # Mutually exclusive with k_per_cov_initial.
  # targets_total_initial: 150

  # Growth factor for "exp" density mode.
  density_exp_base: 2

  # Density bias:
  #   "none"         → uniform selection per coverage cell
  #   "proportional" → higher k in denser regions
  #   "inverse"      → higher k in sparser regions
  density_bias_mode: "proportional"

  # Power-law exponent controlling bias strength (e.g. 0.5=soft, 2.0=strong).
  density_bias_exponent: 0.5

  # Optional per-level overrides (depth: k_per_cov value).
  # These override the density law at specific depths.
  # k_per_cov_per_level:
  #   3: 0.5
  #   5: 2.0
  #   7: 5.0

  # Optional global caps: total target rows per depth (depth: total count).
  # targets_total_per_level:
  #   1: 1000
  #   2: 2000
  #   3: 4000

  # Fractional mode for k_per_cov:
  #   "random" → probabilistic (no score preference)
  #   "score"  → prefers best scores (global/local depending on fractional_mode_logic)
  fractional_mode: "score"

  # Scope for fractional logic:
  #   "local"  → applied per coverage cell (__icov__)
  #   "global" → applied to all coverage cells jointly
  fractional_mode_logic: "local"

  # Extra candidates per coverage cell near the cutoff (helps with score ties).
  tie_buffer: 2


  # ==============================
  # Global magnitude-complete mode ONLY
  # (selection_mode: mag_global)
  # ==============================

  # Name of the magnitude column to use for global ordering and histogram.
  # Required when selection_mode = "mag_global".
  # mag_column: "mag_cModelFlux"

  # Magnitude range that is complete across all depths.
  # Required when selection_mode = "mag_global".
  # mag_min: 17.0
  # mag_max: 24.5

  # Number of bins for the global magnitude histogram (controls quantile resolution).
  # mag_hist_nbins: 2048

  # Optional approximate global targets per depth (mag_global only).
  # They must be provided in order:
  #   n_1 only, or n_1 + n_2, or n_1 + n_2 + n_3.
  # n_2 requires n_1; n_3 requires both n_1 and n_2.
  # n_1: 1000
  # n_2: 3000
  # n_3: 7000


# -----------------------------------------------------------------------------
# Cluster settings (Dask or SLURM)
# -----------------------------------------------------------------------------
cluster:
  # Execution mode: "local" (LocalCluster) or "slurm" (SLURMCluster)
  mode: slurm

  # Dask worker configuration
  n_workers: 20
  threads_per_worker: 8
  memory_per_worker: "12GB"

  # Memory vs throughput presets:
  #   Low-memory  → persist_ddfs: false, avoid_computes_wherever_possible: true
  #   High-speed  → persist_ddfs: true,  avoid_computes_wherever_possible: false
  persist_ddfs: false
  avoid_computes_wherever_possible: true

  # SLURM options (only used if mode: slurm)
  slurm:
    queue: "cpu_small"
    account: "hpc-bpglsst"
    job_extra_directives:
      - "--partition=cpu_small"
      - "--time=02:00:00"
    # Optional extras:
    # - "--constraint=..."
    # - "--qos=..."
    # - "--mem=0"   # use all node memory if allowed

    # Dask performance reports:
    # "none" → disabled, "local" → per-depth, "global" → full pipeline
    diagnostics_mode: global


# -----------------------------------------------------------------------------
# Output settings
# -----------------------------------------------------------------------------
output:
  # Output root directory for the HiPS hierarchy.
  out_dir: "/scratch/users/luigi.silva/sky-viewer/docs/hipsgen_python_parallelized/DES_DR2_spatial_cut"

  # Catalog / HiPS name (used in metadata and folder names).
  cat_name: "DES_DR2_spatial_cut"

  # Default sky position for visualization (RA DEC, degrees).
  target: "0 0"

  # Unique IVOID identifier for this HiPS (required by HiPS 1.4).
  creator_did: "ivo://PRIVATE_USER/DES_DR2_spatial_cut"

  # Short human-readable title for the HiPS (required by HiPS 1.4).
  obs_title: "DES DR2 small sample with spatial cut"