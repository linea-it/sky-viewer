# =============================================================================
# HiPS Catalog Pipeline — config.yaml (Template)
# =============================================================================
# Configuration file for Hipsgen-cat.py
#
# The pipeline:
#   - Reads large catalogs (Parquet / CSV / TSV / HATS)
#   - Distributes data with Dask or LSDB (depending on format)
#   - Selects sources per HEALPix coverage cell (__icov__)
#   - Writes HiPS-compliant tiles (Norder*/Dir*/Npix*.tsv)
#   - Produces MOC, density maps, metadata, and logs
#
# HATS catalogs:
#   - Opened via lsdb.open_catalog()
#   - Preserve LSDB structure and HEALPix partitioning
#   - Use existing HEALPix index (_healpix_<order>) for __icov__ and density maps
#   - Skip repartitioning and shuffle to ensure consistency
# =============================================================================


# -----------------------------------------------------------------------------
# Input catalog(s)
# -----------------------------------------------------------------------------
input:
  # Input file(s) or directories (supports wildcards).
  # Parquet/CSV/TSV → file paths; HATS → root catalog folder.
  paths:
    - "/path/to/your/catalog/*.parquet"

  # Format: "parquet", "csv", "tsv", or "hats"
  format: parquet

  # For CSV/TSV:
  #   header: true  → first row has column names
  #   header: false → positional columns (RA/DEC/score as 1-based indices)
  # header: true

  # Optional hint for ASCII formats (usually not needed).
  # ascii_format: CSV


# -----------------------------------------------------------------------------
# Column mapping and score definition
# -----------------------------------------------------------------------------
columns:
  # RA/DEC column names or 1-based indices (if no header).
  ra: ra
  dec: dec

  # Score expression to rank sources within each coverage cell/tile.
  # Example: "mag_r" or "(flux_g / err_g)**2"
  # order_desc=false → lower is better; true → higher is better.
  score: "mag_r"

  # Optional explicit list of columns to keep in output tiles.
  # If omitted, keeps RA/DEC, score-related, and all input columns.
  keep:
    - ra
    - dec
    - mag_g
    - mag_r


# -----------------------------------------------------------------------------
# Algorithmic controls
# -----------------------------------------------------------------------------
algorithm:
  # Maximum HiPS order (tiles written for all levels ≤ this).
  level_limit: 11

  # HEALPix order used for MOC and density maps.
  level_coverage: 10

  # HEALPix order for coverage cells (__icov__).
  # Ignored if use_hats_as_coverage=true.
  coverage_order: 10

  # Use HATS catalog partitioning as coverage (format: hats only).
  # When true, coverage_order is ignored.
  use_hats_as_coverage: false

  # Score ordering: false → ascending; true → descending.
  order_desc: false

  # Density variation with depth: constant, linear, exp, or log.
  density_mode: "exp"

  # Density bias (optional; default = none)
  # none         → uniform selection per coverage cell
  # proportional → higher k in denser regions
  # inverse      → higher k in sparser regions
  density_bias_mode: "proportional"

  # Power-law exponent controlling bias strength (e.g. 0.5=soft, 2.0=strong)
  density_bias_exponent: 0.5

  # Base expected number of rows per coverage cell at depth=1.
  # Mutually exclusive with targets_total_initial.
  k_per_cov_initial: 0.05

  # Base expected total number of rows at depth=1.
  # Mutually exclusive with k_per_cov_initial.
  # targets_total_initial: 150

  # Growth factor for "exp" density mode.
  density_exp_base: 2

  # Optional per-level overrides (depth: k_per_cov value).
  # k_per_cov_per_level:
  #   3: 0.5
  #   5: 2.0
  #   7: 5.0

  # Optional global caps: total target rows per depth (depth: total count).
  # targets_total_per_level:
  #   1: 1000
  #   2: 2000
  #   3: 4000

  # Fractional mode:
  #   random → probabilistic (no score preference)
  #   score  → prefers best scores
  fractional_mode: "score"

  # Fractional logic scope:
  #   local  → independent per coverage cell (__icov__)
  #   global → applied to all coverage cells jointly
  fractional_mode_logic: "local"

  # Extra candidates per coverage cell near cutoff.
  tie_buffer: 2


# -----------------------------------------------------------------------------
# Cluster settings (Dask or SLURM)
# -----------------------------------------------------------------------------
cluster:
  # Execution mode: "local" (LocalCluster) or "slurm" (SLURMCluster)
  mode: local

  # Dask worker configuration
  n_workers: 8
  threads_per_worker: 4
  memory_per_worker: "8GB"

  # Memory vs throughput presets:
  #   Low-memory  → persist_ddfs: false, avoid_computes_wherever_possible: true
  #   High-speed  → persist_ddfs: true,  avoid_computes_wherever_possible: false
  persist_ddfs: false
  avoid_computes_wherever_possible: true

  # SLURM options (only used if mode: slurm)
  slurm:
    queue: "cpu"
    account: "your-account"
    job_extra_directives:
      - "--partition=cpu"
      - "--time=02:00:00"
    # Optional extras:
    # - "--constraint=..."
    # - "--qos=..."
    # - "--mem=0"   # use all node memory if allowed

    # Dask performance reports:
    # "none" → disabled, "local" → per-depth, "global" → full pipeline
    diagnostics_mode: global


# -----------------------------------------------------------------------------
# Output settings
# -----------------------------------------------------------------------------
output:
  # Output root directory for the HiPS hierarchy.
  out_dir: "/path/to/output/hips_catalog"

  # Catalog / HiPS name (used in metadata and folder names).
  cat_name: "My_HiPS_Catalog"

  # Default sky position for visualization (RA DEC, degrees).
  target: "0 0"

  # Unique IVOID identifier for this HiPS (required by HiPS 1.4).
  creator_did: "ivo://PRIVATE_USER/My_HiPS_Catalog"

  # Short human-readable title for the HiPS (required by HiPS 1.4).
  obs_title: "My HiPS Catalog for testing"